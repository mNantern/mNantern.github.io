---
layout: post
title: Ansible - l'orchestration facile (2/2)
date: 2013-09-07
comments: false
categories: fr
excerpt: Seconde partie de l'article sur Ansible, un outil de provisioning comparable à Puppet.
---

<div class='post'>
<div class="separator" style="clear: both; text-align: center;"><a href="{{ site.url }}/assets/AnsibleNoTag_CLR.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="{{ site.url }}/assets/AnsibleNoTag_CLR.jpg" height="78" width="640" /></a></div><br />Cet article est la suite de l'<a href="http://blog.nantern.com/fr/2013/09/06/ansible-l-orchestration-facile.html" target="_blank">article n°1</a> présentant Ansible. Celui-ci a pour but de créer notre premier playbook.<br /><br />En route ! <br /><h2>Mon premier Playbook</h2><h3>Objectifs</h3><br />Maintenant que l'on dispose de notre structure de base, on va configurer la liste des tâches permettant d'installer Tomcat8 sur un Ubuntu 12.04 à savoir:<br /><br /><ol start="1" type="1"><li>Installer le paquet OpenJDK 7 (le paquet se nomme openjdk-7-jdk)</li><li>Créer un dossier permettant le téléchargement de l'archive de tomcat8 (dans /home/vagrant/archives)</li><li>Télécharger tomcat8 depuis le <a class="http" href="http://apache.crihan.fr/dist/tomcat/tomcat-8/v8.0.0-RC1/bin/apache-tomcat-8.0.0-RC1.tar.gz" title="miroir suivant">miroir suivant</a></li><li>Créer le dossier /opt/apache-tomcat appartenant à l'utilisateur vagrant</li><li>Décompresser notre archive</li><li>Créer un lien symbolique de /opt/apache-tomcat/apache-tomcat-8.0.0-RC1 à /opt/apache-tomcat/tomcat8</li><li>Modifier le fichier server.xml</li><li>Redémarrer tomcat à chaque fois que le fichier catalina.properties est modifié</li></ol><h3>Résolution</h3><h4>Étape 1: installer un paquet</h4><h4>&nbsp;</h4>On va créer une tâche permettant l'installation d'un paquet sur notre Ubuntu dans le fichier roles/tomcat8/tasks/main.yml:<br /><br />  <pre class="prettyprint"><br />- name: install package openJDK 7<br />  apt: pkg=openjdk-7-jdk update_cache=yes<br />  sudo: yes<br /></pre><br />   Toutes les tâches nécessitent un nom qui sera affiché lors de l'exécution d'Ansible.<br />La deuxième ligne précise le module a utiliser à savoir ici le module "apt", on lui passe deux paramètres pkg (qui indique le nom du paquet à installer) et update_cache (qui va déclencher un apt-get update avant l'installation). Mais il existe <a class="http" href="http://www.ansibleworks.com/docs/modules.html#apt" title="d'autres options">d'autres options</a>.<br />Enfin la dernière ligne indique qu'il faut lancer cette commande via sudo.<br /><br />   Testons maintenant notre première tâche via la commande suivante qui va exécuter notre playbook <strong>site.yml</strong> sur l'ensemble des machines de notre fichier <strong>production</strong>:<br /><br />  <pre class="prettyprint"><br />$ ansible-playbook -i production site.yml</pre><br />   Et le résultat (ça peut prendre un peu de temps):<br /><pre class="prettyprint"><br />PLAY [application-server] ***************************************************** <br /><br />GATHERING FACTS *************************************************************** <br /><br />ok: [127.0.0.1]<br /><br />TASK: [install package openJDK 7] ********************************************* <br /><br />changed: [127.0.0.1]<br /><br />PLAY RECAP ******************************************************************** <br /><br />127.0.0.1                  : ok=2    changed=1    unreachable=0    failed=0  <br /><br /></pre>   Si vous avez des vaches qui s'affichent vous pouvez soit désinstaller le paquer cowsay soit exécuter la commande suivante:<br /><pre class="prettyprint">export ANSIBLE_NOCOWS=1</pre><br />  <h4>Étape 2: créer un dossier</h4><h4>&nbsp;</h4>Pour créer un dossier on ajoute juste une tâche à notre fichier main.yml en utilisant le module <a class="http" href="http://www.ansibleworks.com/docs/modules.html#id181" title="file">file</a>:<br /><pre class="prettyprint"><br />- name: create archives folder<br />  file: path=/home/vagrant/archives state=directory<br /></pre>   On teste à nouveau et voilà le résultat:<br /><pre class="prettyprint"><br />PLAY [application-server] ***************************************************** <br /><br />GATHERING FACTS *************************************************************** <br /><br />ok: [127.0.0.1]<br /><br />TASK: [install package openJDK 7] ********************************************* <br /><br />ok: [127.0.0.1]<br /><br />TASK: [create archives folder] ************************************************ <br /><br />changed: [127.0.0.1]<br /><br />PLAY RECAP ******************************************************************** <br /><br />127.0.0.1                  : ok=3    changed=1    unreachable=0    failed=0   <br /><br /></pre>    On peut voir ici qu'Ansible ne ré-installe pas le package openJDK (statut: ok) mais créé par contre bien notre dossier (statut: changed).<br /><br />   Pour les étapes suivantes je vais vous laisser travailler en ne vous donnant que le nom des modules à utiliser. Le fichier final main est indiqué à la fin de l'article.<br /><br />  <h4>Étape 3: télécharger une archive</h4><h4>&nbsp;</h4>Utiliser pour cela le module <a class="http" href="http://www.ansibleworks.com/docs/modules.html#get-url" title="get_url">get_url</a>.<br /><br />  <h4>Étape 4: créer un dossier</h4><h4>&nbsp;</h4>Voir l'étape 2 en ajoutant les options qui vont bien.<br /><br />  <h4>Étape 5: décompresser une archive</h4><h4>&nbsp;</h4>Utiliser pour cela le module <a class="http" href="http://www.ansibleworks.com/docs/modules.html#command" title="command">command</a>. Attention à bien utiliser l'option <strong>creates</strong> pour ne pas décompresser l'archive à chaque exécution d'Ansible.<br /><br />  <h4>Étape 6: créer un lien symbolique</h4><h4>&nbsp;</h4>Encore et toujours le module <a class="http" href="http://www.ansibleworks.com/docs/modules.html#id181" title="file">file</a> avec les options dest et src ce coup-ci.<br /><br />  <h4>Étape 7: Modifier le fichier server.xml</h4><h4>&nbsp;</h4>Pour copier un fichier depuis notre dossier roles/tomcat8/files il suffit d'utiliser le <a class="http" href="http://www.ansibleworks.com/docs/modules.html#id179" title="module copy">module copy</a>. Pour l'exemple le fichier local copié sur le serveur distant est le fichier server.xml classique auquel ont été enlevé les commentaires:<br /><br />  <pre class="prettyprint"><br />- name: Copy server.xml<br />  copy: dest=/opt/apache-tomcat/tomcat8/conf/server.xml owner=vagrant group=vagrant src=roles/tomcat8/files/server.xml<br /></pre>   <h4>Étape 8: Redémarrer automatiquement Tomcat</h4><h4>&nbsp;</h4>L'étape précédente nous a permis de modifier facilement la configuration de nos serveurs Tomcat. Néanmoins il faut après une modification de la conf redémarrer le serveur.<br />Pour réaliser cela nous allons ajouter un handler, une action qui ne sera exécutée que sur notification d'une autre action. Ainsi si le fichier de conf n'est pas modifié Tomcat ne sera pas redémarré.<br />On ajoute une ligne à notre tâche de l'étape 7 pour notifier notre handler:<br /><br />  <pre class="prettyprint"><br />- name: Copy server.xml<br />  copy: dest=/opt/apache-tomcat/tomcat8/conf/server.xml owner=vagrant group=vagrant src=roles/tomcat8/files/server.xml<br />  notify: restart tomcat<br /></pre>   Et on créé le fichier handler correspondant dans roles/tomcat8/handlers/main.yml:<br /><br />  <pre class="prettyprint"><br />- name: restart tomcat<br />  shell: /opt/apache-tomcat/tomcat8/bin/shutdown.sh &amp;&amp; /opt/apache-tomcat/tomcat8/bin/startup.sh<br /></pre>   Voilà normalement lors de la prochaine modification du fichier server.xml notre tomcat sera redémarré. Pour tester nous pouvons rajouter une ligne vide dans le fichier roles/tomcat8/files/server.xml et relancer ansible-playbook:<br /><br />  <pre class="prettyprint"><br />PLAY [application-server] ***************************************************** <br /><br />GATHERING FACTS *************************************************************** <br /><br />ok: [127.0.0.1]<br /><br />TASK: [install package openJDK 7] ********************************************* <br /><br />ok: [127.0.0.1]<br /><br />TASK: [create archives folder] ************************************************ <br /><br />ok: [127.0.0.1]<br /><br />TASK: [Download Tomcat 8] ***************************************************** <br /><br />ok: [127.0.0.1]<br /><br />TASK: [Create tomcat directory] *********************************************** <br /><br />ok: [127.0.0.1]<br /><br />TASK: [Unzip tomcat] ********************************************************** <br /><br />skipping: [127.0.0.1]<br /><br />TASK: [Create Tomcat symlink] ************************************************* <br /><br />ok: [127.0.0.1]<br /><br />TASK: [Copy server.xml] ******************************************************* <br /><br />changed: [127.0.0.1]<br /><br />NOTIFIED: [restart tomcat] **************************************************** <br /><br />changed: [127.0.0.1]<br /><br />PLAY RECAP ******************************************************************** <br /><br />127.0.0.1                  : ok=8    changed=2    unreachable=0    failed=0   <br /><br /></pre>   <h3>Fichier Final</h3><script src="https://gist.github.com/mNantern/6474380.js"></script><h3>&nbsp;</h3><h2>Aller plus loin</h2>Il est possible de faire encore plus de chose avec Ansible comme par exemple :<br /><br /><ul><li>utiliser des <a class="http" href="http://www.ansibleworks.com/docs/modules.html#template" title="templates">templates</a> et des <a class="http" href="http://www.ansibleworks.com/docs/playbooks2.html#id6" title="variables">variables</a></li><li>utiliser les rôles...</li><li>et les tags</li></ul>Bref aller jeter un oeil à la <a class="http" href="http://www.ansibleworks.com/docs/" title="doc">doc</a> qui bien qu'un peu fouillis contient l'essentiel.<br /><br /><br />   Post 14/52</div>
