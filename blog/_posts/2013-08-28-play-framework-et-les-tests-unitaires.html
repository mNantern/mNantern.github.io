---
layout: post
title: Play Framework et les Tests Unitaires
date: 2013-08-28
comments: false
categories: fr
excerpt: Utilisation des tests unitaires et du coverage avec Play! Framework.
---

<div class='post'>
<div class="separator" style="clear: both; text-align: center;"><a href="{{site.url}}/assets/play.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="{{site.url}}/assets/play.png" height="217" width="640" /></a></div><br /><br />Depuis quelques jours, je joue avec <a href="http://www.playframework.com/" title="Play!">Play!</a>, un framework web Java.<br />Il possède plusieurs avantages forts sympathiques je trouve:<br /><br /><ul><li>Stateless</li><li>REST</li><li>Asynchrone</li><li>Intgérant nativement Junit</li></ul>Et c'est de ce dernier point en particulier que je vais parler aujourd'hui car l'intégration n'est pas si native que cela et je suis tombé sur plusieurs bugs gênants.<br /><br />  <h2>play test ne fait rien</h2><br />   La méthode conseillée pour lancer les tests est la commande "play test" mais malheureusement avec la version 2.1.3, cette commande ne teste absolument rien. Gênant <a href="https://github.com/playframework/playframework/issues/1437" title="ce bug">ce bug</a>...<br />Pour contourner cela il est nécessaire d'ajouter dans le fichier <b>project/Build.scala</b> les lignes suivantes:<br /><br /><br />  <pre class="prettyprint">val appDependencies = Seq(<br />    // Add your project dependencies here,<br />    javaCore,<br />    javaJdbc,<br />    javaEbean,<br />    "play" %% "play-test" % play.core.PlayVersion.current % "test" exclude("com.novocode", "junit-interface"),<br />    "com.novocode" % "junit-interface" % "0.9" % "test"<br />)<br /><br /><br /></pre>Ce problème devrait être corrigée dans la 2.1.4 qui ne devrait pas tarder à sortir.<br /><br />  <h2>play test se bloque lors des tests IHM</h2><br />   Il est possible avec Play! Framework de réaliser des tests fonctionnels en testant directement une page de notre application. Pour cela on utilise un testbrowser (cf <a href="http://www.playframework.com/documentation/2.1.3/JavaFunctionalTest" title="la documentation sur le sujet">la documentation sur le sujet</a>).<br /><br />Malheureusement si l'on fait cela avec la version actuelle de Play! Framework cela va bloquer entièrement la commande "play test" qui ne sera donc plus très utile.<br /><br />Cela est dû à une incompatibilité avec la version de JQuery livré avec Play! Framework d'après <a href="https://github.com/playframework/playframework/issues/832" title="ce bug">ce bug</a>.<br />La seule façon de débloquer cela est de <a href="http://code.jquery.com/jquery-1.8.3.min.js" title="télécharger la version 1.8.3">télécharger la version 1.8.3</a> de jquery et de l'ajouter dans le dossier public/javascript en remplacement de la version 1.9.0 (ne pas oublier de mettre à jour vos pages aussi).<br /><br />   <h2>Lancer les tests unitaires depuis Eclipse</h2><br />   La commande "play test" est sympathique mais il arrive très régulièrement que l'on souhaite lancer uniquement un test ou une classe de tests depuis notre Eclipse et là malheureusement cela ne marche pas comme attendu à cause de l'erreur suivante:<br /><br /><br />  <pre class="prettyprint">java.lang.IllegalStateException: Class [class play.db.ebean.Model] is enhanced and [class models.Company] is not - (you can not mix!!)</pre><br /><br /><br />   Pour corriger cela il est nécessaire de <a href="http://www.avaje.org/download.html" title="télécharger le jar d'ebean">télécharger le jar d'ebean</a> et de l'ajouter en tant que paramètre par défaut dans Eclipse. Pour cela il est nécessaire d'aller dans <strong>Preferences &gt; Java &gt; Installed JRE &gt; Edit</strong> et d'ajouter la ligne suivante:<br /><br /><br />   <pre class="prettyprint">-javaagent:/path/to/ebean/ebean-2.7.3-agent.jar</pre><br /><br />  <br />Et voilà ça devrait mieux aller !<br /><br />  <br />Vraiment ? Pas dans tous les cas en fait. Il peut arriver que suite à cela un test soit cassé car lors d'un select en base via Ebean qui renvoie un objet avec un champ null.<br />Dans mon cas il s'agissait d'un champ Text (ou <span class="zim-tag">@Lob</span> pour Ebean) qui était systématiquement vide alors que l'objet inséré le contenait bien.<br /><br />Pour corriger cela il faut passer le champ concerné en private et générer soit même les getter/setter au lieu de laisser Play! le faire tout seul.<br />Et c'est tant mieux, je n'aime pas le fait d'avoir l'ensemble de mes champs public ça casse un peu le principe de l'encapsulation.<br /><br />  <h2>Fichier "init-data.conf" non trouvé</h2><br />   Si vous avez suivi les tutoriels du site Play! Framework vous avez vu que l'on peux ajouter facilement des données aux tests ou à l'application en cours de développement en créant un fichier Yaml dans le dossier conf/ et contenant l'ensemble des éléments à créer en base.<br /><br />Le problème étant que si l'on fait les tests ensuite via Junit dans Eclipse il ne va jamais trouver ce fichier et donc ne va pas précharger votre base de données...<br /><br />Pour corriger cela il faut ajouter le dossier conf au classpath d'Eclipse car celui-ci n'est <a href="https://github.com/playframework/playframework/issues/1319" title="pas ajouté lors de la commande &quot;play eclipse&quot;">pas ajouté lors de la commande "play eclipse"</a>.<br /><br />Pour l'ajouter il suffit de faire un click droit sur le dossier conf/ dans le projet et choisir <strong>"Build Path" &gt; "Use as Source Folder"</strong>.<br /><br />  <h2>Je veux le coverage de mon code !</h2><br />   Maintenant que l'on a des tests qui fonctionnent que ça soit via la commande play test ou dans Eclipse on aimerait bien avoir également la couverture de code que l'on teste. Nous allons utiliser <a href="http://www.eclemma.org/jacoco/" title="jacoco">jacoco</a> pour générer notre coverage.<br /><br />Pour cela il faut ajouter plusieurs éléments à notre configuration:<br /><br />    <ul><li>Dans le fichier <strong>project/plugins.sbt </strong>ajouter les lignes suivantes<strong>:</strong></li></ul><pre class="prettyprint">libraryDependencies ++= Seq(<br />  "org.jacoco" % "org.jacoco.core" % "0.5.9.201207300726" artifacts(Artifact("org.jacoco.core", "jar", "jar")),<br />  "org.jacoco" % "org.jacoco.report" % "0.5.9.201207300726" artifacts(Artifact("org.jacoco.report", "jar", "jar")))<br /><br />addSbtPlugin("de.johoop" % "jacoco4sbt" % "1.2.4")<br /></pre><ul><li><strong>Dans le fichier project/Build.scala:</strong></li></ul><ul style="padding-left: 30pt;"><li>Ajouter sous les import déjà existant les lignes suivantes:</li></ul><pre class="prettyprint">import de.johoop.jacoco4sbt._<br />import JacocoPlugin._<br /></pre><ul style="padding-left: 30pt;"><li>Ajouter sous le bloc "val appDependencies = Seq(...)" une ligne:</li></ul><pre class="prettyprint">lazy val s = Defaults.defaultSettings ++ Seq(jacoco.settings:_*)</pre><br /><br />    <ul style="padding-left: 30pt;"><li>Puis modifier le dernier bloc pour qu'il ressemble à cela (attention à bien ajouter le paramètre settings = s):</li></ul><pre class="prettyprint">val main = play.Project(appName, appVersion, appDependencies, <b>settings = s</b>).settings(<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />    parallelExecution     in jacoco.Config := false,&nbsp;&nbsp;&nbsp;&nbsp;<br />    jacoco.reportFormats  in jacoco.Config := Seq(XMLReport("utf-8"), HTMLReport("utf-8")),&nbsp;&nbsp;&nbsp;&nbsp;<br />    jacoco.excludes       in jacoco.Config := Seq("views.*", "controllers.Reverse*", "controllers.javascript.*", "controllers.ref.*", "Routes*")<br />  )</pre><br /><br /><br />     Et voilà la couverture peut maintenant être générée via la commande:<br /><br />   <pre class="prettyprint">play jacoco:cover</pre><br /><br /><br />   L'ensemble des fichiers seront placés dans le dossier <strong>/target/scala-2.9.1/jacoco/html</strong>.<br /><br />  <br />Petit exemple du look:<br /><br />    <div class="separator" style="clear: both; text-align: center;"><a href="{{site.url}}/assets/jacoco.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="{{site.url}}/assets/jacoco.png" height="98" width="400" /></a></div><br /><br /><br /><br />    Post 11/52<br /> </div>
