---
layout: post
title: Memcached - principe de fonctionnement
date: 2013-03-06
comments: false
categories: fr
excerpt: Première partie d'une série sur Memcached, un cache distribué haute performance. Aujourd'hui le principe de fonctionnement de Memcached.
---

<div class='post'>
<div class="separator" style="clear: both; text-align: center;"><a href="{{site.url}}/assets/memcached.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="{{site.url}}/assets/memcached.png" height="118" width="640" /></a></div><br />Cette article est le premier d'une série de trois qui a pour but de présenter Memcached, la gestion de la mémoire et les optimisations possibles.<br /><br /><br /><h2>Présentation</h2>Comme le dit si bien <a href="https://fr.wikipedia.org/wiki/Memcached" target="_blank">Wikipedia</a>: <br />"Memcached est un système d'usage général servant à gérer la mémoire cache distribuée. Il est souvent utilisé pour augmenter la vitesse de réponse des sites web créés à partir de bases de données."<br /><br /><br />Le principe ici est que plutôt que d'aller chercher régulièrement certaines données en base il vaut mieux conserver cette donnée dans la mémoire afin de pouvoir y accéder plus rapidement. De la même façon on peut stocker ainsi le résultat de calculs couteux , des données à écrire en base (pour de l'écriture asynchrone) ou encore des pages web.<br /><br /><br />Comme indiqué précédemment Memcached est un outil de stockage des données en mémoire de type clé - valeur. La principale conséquence de cela est que si la machine s'arrête on perd l'ensemble des données stockées dans Memcached. Il ne faut donc pas stocker les données importantes uniquement à cet endroit.<br /><br /><br />Ceci étant dit, Memcached est un outil fantastique pour améliorer la vitesse d'un site pour la bonne et simple raison qu'il est beaucoup beaucoup plus rapide d'accéder à de la mémoire qu'à un disque dur. Voici quelques ordres de grandeurs de temps d'accès:<br /><br /><ul><li>100 ns (10<sup>-7 </sup>s): temps d'accès à la mémoire</li><li>10 000 000 ns (10<sup>-2</sup> s): temps d'accès à un disque dur</li></ul>Et tout de suite on voit que la mémoire est 100 000 fois plus lente qu'un accès disque disque... Bingo plein de perf' !<br /><br /><br />L'idée générale de Memcached est d'offrir un outil simple mais très performant afin de profiter au maximum de la vitesse de la mémoire. Il est possible d'accéder à Memcached via la majorité des langages utilisés à l'heure actuelle. <br /><br /><h2>Principe de fonctionnement</h2>Au moment du lancement du processus memcached on lui assigne une taille maximale (via le paramètre -m). Cet espace mémoire est ensuite découpé en <b>page</b> d'une taille fixe de 1 Mio (par défaut). La première conséquence de ce découpage est que l'on ne peut pas stocker dans Memcached des éléments de plus de 1Mio.<br /><br /><br />Ensuite Memcached découpe ses pages de 1 Mio en éléments appelés des <b>chunks</b>. Un chunk est un espace mémoire de taille fixe qui va stocker la clé, la donnée associée et quelques infos destinées à Memcached. Si l'on spécifie par exemple une taille de chunk de 96 octets (paramètre -n) alors tous les éléments d'une taille (taille de la clé + taille de la donnée + métadonnée Memcached) inférieure à 96 octets occuperont un espace de 96 octets en mémoire.<br /><br /><br />Tous les éléments d'une même taille sont stockés dans une <b>classe</b> <b>slab</b>. Ainsi notre premier slab contient tous les éléments d'une taille comprise entre 1 et 96 octets.<br /><br />Lors de l'insertion de la première donnée dans Memcached celui-ci vérifie d'abord à quelle classe appartient l'élément inséré puis décompose une page de 1Mio en chunks de la taille des éléments du slab.<br />Par exemple avec notre slab contenant des éléments de 96 octets, Memcached découpe sa page de 1 Mio en 10 922 chunks. Une fois les 10 922 chunks remplis Memcached assigne une nouvelle page de 1Mio au slab.<br /><br /><br />Dans le cas où l'élément fait plus de 96 octets Memcached détermine la taille du slab suivant en utilisant le facteur d'augmentation (paramètre -f). Par exemple avec un facteur de 2 le deuxième slab hébergera des éléments d'une taille maximale de 192 octets mais ne pourra plus héberger que 5461 chunks.<br /><br /><br />En lançant Memcached avec le paramètre -vv on obtient la taille des différents slabs ainsi que le nombre de chunks pouvant être stocké par page:<br /><br /><br /><pre class="prettyprint">~ $ memcached -vv -f 2 -m 512<br />slab class   1: chunk size        96 perslab   10922<br />slab class   2: chunk size       192 perslab    5461<br />slab class   3: chunk size       384 perslab    2730<br />slab class   4: chunk size       768 perslab    1365<br />slab class   5: chunk size      1536 perslab     682<br />slab class   6: chunk size      3072 perslab     341<br />slab class   7: chunk size      6144 perslab     170<br />slab class   8: chunk size     12288 perslab      85<br />slab class   9: chunk size     24576 perslab      42<br />slab class  10: chunk size     49152 perslab      21<br />slab class  11: chunk size     98304 perslab      10<br />slab class  12: chunk size    196608 perslab       5<br />slab class  13: chunk size    393216 perslab       2<br />slab class  14: chunk size   1048576 perslab       1</pre><pre>&nbsp;</pre>On obtient donc 14 classes dont la taille varie entre 96 octets et 1 Mio et pouvant stocker entre 10 922 et 1 élément(s).<br /><br /><br />Nous avons donc notre espace de stockage mémoire qui écoute par défaut sur le port 11211. Pour insérer et lire des données il suffit d'utiliser l'un des nombreux bindings disponibles dans tous les langages, par exemple l'extension PHP Memcache:<br /><br /><br /><pre class="prettyprint">&lt;?php<br /><br />$memcache = new Memcache;<br />$memcache-&gt;connect('localhost', 11211) or die ("Could not connect");<br /><br />// Insert 'data' for 10 seconds in Memcached<br />$memcache-&gt;set('key', 'data', false, 10) or die ("Failed to save data");<br /><br />$get_result = $memcache-&gt;get('key');<br /><br />var_dump($get_result);<br /><br />?&gt;</pre><pre>&nbsp;</pre>Comme on peut le voir on insère des données pour une durée déterminée dans Memcached  (maximum 30 jours). Mais que se passe-t-il si malgré tout Memcached vient à manquer de mémoire ?<br /><br /><br />Il existe alors un ensemble de mécanisme destiné à libérer de la mémoire. C'est ce que nous allons voir dans la deuxième partie: <a href="http://blog.nantern.com/fr/2013/03/08/memcached-gestion-de-la-memoire.html" target="_blank">"Memcached: gestion de la mémoire"</a>.<br /><br />Posts&nbsp; 4/52</div>
