---
layout: post
title: Memcached - optimisation
date: 2013-03-09
comments: false
categories: fr
excerpt: Dernière partie d'une série sur Memcached, un cache distribué haute performance. Cette partie présente comment optimiser Memcached pour en tirer le meilleur
---

<div class='post'>
<div class="separator" style="clear: both; text-align: center;"><a href="{{site.url}}/assets/memcached.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="{{site.url}}/assets/memcached.png" height="118" width="640" /></a></div><br />Cet article fait partie d'une série de trois posts sur Memcached. Il fait suite au premier article: <a href="http://blog.nantern.com/fr/2013/03/06/memcached-principe-de-fonctionnement.html" target="_blank">"Memcached: principe de fonctionnement"</a> et au deuxième article: <a href="http://blog.nantern.com/fr/2013/03/08/memcached-gestion-de-la-memoire.html" target="_blank">"Memcached: Gestion de la mémoire"</a>.<br />Troisième et dernier article sur Memcached et on finit en beauté: comment optimiser son Memcached afin de faire toujours plus avec la même quantité de mémoire !<br /><br /><h2>Optimiser l'utilisation de son Memcached</h2><h3>Superviser son Memcached</h3>Avant de modifier les paramètres de son Memcached il faut d'abord pouvoir les observer afin de vérifier que ce que l'on fait améliore effectivement les choses.<br /><br />   Pour cela deux options faciles:<br /><br /><ul><li>utiliser l'<a href="http://lzone.de/articles/memcached.htm" title="interface telnet">interface telnet</a> fournie afin d'obtenir des informations sur le serveur. Les informations intéressantes sont fournies par la commande "stats" et "stats slabs"</li><li>utiliser un script PHP affichant de manière un peu plus sympathique l'état du Memcached. Ce script est disponible sur <a href="http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/" title="le blog de l'auteur">le blog de l'auteur</a>.</li></ul><div class="separator" style="clear: both; text-align: center;"><a href="{{site.url}}/assets/apc_memcache.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><br /></a></div><div class="separator" style="clear: both; text-align: center;"><a href="{{site.url}}/assets/apc_memcache.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="{{site.url}}/assets/apc_memcache.png" height="334" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><br /><br /> <br /><br />   Les informations qui nous intéressent sont le compteur d'éviction (accessible uniquement via l'interface telnet) et le nombre d'éléments par slabs (via la commande "stats slabs" ou le bouton "variables" de memcached.php):<br /><br />  <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="{{site.url}}/assets/apc_memcache2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="{{site.url}}/assets/apc_memcache2.png" height="408" width="640" /></a></div><br /><br />  <h3>Quelques conseils</h3>Afin de tirer le meilleur partie de Memcached il faut vérifier que:<br /><br /><ol start="1" type="1"><li>Les dates d'expiration ont été correctement paramétrées ; rien ne sert de remplir la mémoire avec des éléments inutiles. Vérifier pour cela le pourcentage de hit sur vos get memcached si celui-ci est trop bas soit vous n'avez pas assez de mémoire pour stocker tous vos éléments soit vos durées d'expiration sont trop courtes.<br /></li><li>Les données sont réparties harmonieusement au sein des slabs: si vous avez un slab qui contient 90% des éléments il peut être intéressant de partitionner plus finement ce slab en jouant sur les paramètres -n (plage de début) et -f (facteur d'augmentation). Voir à ce sujet l'exemple ci-dessous<br /></li><li>Vérifier régulièrement la taille des objets que vous stockez dans Memcached car au fur et à mesure que votre application s'étoffe il se peut que la taille des données stockées dans Memcached augmente et que les paramètres initiaux ne soient plus adaptés.</li></ol>J'ai mis en pratique récemment le conseil numéro 2: il faut savoir que sur mon projet actuel nous utilisons énormément Memcached mais que les paramètres mis en place datent de plus de 4 ans et que le projet n'a plus grand chose à voir avec ce qu'il était à l'époque.<br />En étudiant l'un des Memcached voici ce que j'ai pu constater:<br /><br /><ul><li>De nombreuses évictions (1 par seconde en moyenne)</li><li>65 000 objets max stockés dans le Memcached</li><li>Une distribution sur les différents slabs complètement disproportionnée:</li></ul><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="{{site.url}}/assets/memcache1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="{{site.url}}/assets/memcache1.png" height="372" width="640" /></a></div><br />Avec -n = 8000 et -f = 2<br /><br /><br />   On voit clairement sur le graphique que le premier slab contient l'immense majorité des données. Le paramètre de taille initiale du slab a été visiblement mal choisi et il faut l'affiner.<br />La principale conséquence de ce choix est que l'on utilise 8 kio de mémoire pour tous les objets stockés dans Memcached alors que ceux-ci font en moyenne entre 3 et 4 kio (soit 50% de mémoire perdue à chaque fois!!) ce qui implique que l'on ne peut stocker que peu d'informations.<br />On voit bien ici l'importance de connaître ses données afin d'optimiser au mieux les paramètres.<br /><br />  <br />Nous avons donc modifié les paramètres comme suit:<br /><br /><ul><li>Diminution de la taille du premier slab de 8000 octets à 1000 octets afin de mieux découper l'espace où se trouve nos données</li><li>Même facteur d'accroissement</li><li>Même mémoire allouée</li></ul><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="{{site.url}}/assets/memcache2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="{{site.url}}/assets/memcache2.png" height="376" width="640" /></a></div><br /><br /><br /><br />   Les conséquences de cette modification:<br /><br /><ul><li>Peu d'évictions (Quelques centaines par jour)</li><li><b>125 000 éléments stockés dans Memcached</b> (pour la même quantité de mémoire allouée !!)</li><li>Une distribution mieux répartie</li></ul>On peut se dire au vu du graphique qu'il est encore possible de faire mieux en diminuant le facteur multiplicatif afin de décomposer encore plus le slab3 en de multiples slabs. Cette solution n'a pas été retenue car nous souhaitions garder une relative flexibilité dans la taille de nos données qui sont amenées à bouger régulièrement et donc nous focaliser sur la tranche 3 à 4 kio nous semblait trop réducteur pour les développements futurs de l'application.<br /><br /><br />   C'est ainsi que se termine cette série de trois articles sur Memcached un outil fantastique pour améliorer les performances et la scalabilité de votre application.<br /><br /><br /><br /><br />   Quelques liens intéressants:<br /><br /><ul><li>La page du <a href="http://memcached.org/" title="projet Memcached">projet Memcached</a></li><li>L'algorithme <a href="http://work.tinou.com/2011/04/memcached-for-dummies.html" title="LRU de Memcached en détail">LRU de Memcached en détail</a></li><li>Le <a href="http://code.google.com/p/memcached/wiki/NewStart?tm=6" title="wiki officiel">wiki officiel</a> de Memcached</li><li>L'<a href="http://lzone.de/articles/memcached.htm" title="interface telnet">interface telnet</a></li></ul>Post 6/52 <br />  </div>
