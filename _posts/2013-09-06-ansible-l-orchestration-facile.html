---
layout: post
title: Ansible - l'orchestration facile
date: 2013-09-06
comments: false
categories: fr
excerpt: Première partie d'une série de deux articles sur Ansible un outil de provisioning comparable à Puppet.
---

<div class='post'>
<div class="separator" style="clear: both; text-align: center;"><a href="{{ site.url }}/assets/AnsibleNoTag_CLR.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="{{site.url}}/assets/AnsibleNoTag_CLR.jpg" height="76" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><br /><br />L'une des choses qui m'intéresse énormément ces dernières années est le déploiement automatisé et industrialisé des plateformes en particulier via Puppet. Marre des scripts shell !<br /><br /><h2>Présentation</h2>Aujourd'hui j'ai découvert un outil nommé Ansible semblable à bien des aspects à Puppet mais avec quelques différences très intéressantes:<br /><br /><ul><li>Aucun agent à installer sur les machines cibles. Ca permet de se lancer plus rapidement et plus facilement, on installe ansible et c'est parti !</li><li>Le déploiement et le passage de commande est réalisé via ssh ce qui permet de ne pas tout le temps être en root</li><li>Possibilité de lancer facilement des commandes shell sur tout ou partie de notre plateforme. Du genre un ping ou un apache status chose qui n'est pas facile via Puppet</li><li>Ecrit en python plutôt qu'en ruby (mais ça c'est personnel :)</li><li>Bien plus simple à prendre en main que Puppet</li></ul><br />Après l'outil est encore un peu jeune et manque de certaines fonctionnalités dans la version open-source comme:<br /><br /><ul><li>Avoir un dashboard pour consulter le résultat de déploiements réalisés de manière régulières (via cron par exemple). Actuellement on lance ansible il effectue ses actions et affiche le résultat sur la sortie standard. Pas de console centralisée</li><li>Logs d'exécution. Dans le cas où quelque chose se passe mal, le résultat affiché est très léger et oblige quasiment tout le temps à se logguer sur la machine pour voir de quoi il en retourne alors qu'avoir plus de logs et récupérés sur la machine exécutant ansible serait bien plus pratique quand même !</li><li>Déploiement sous Windows</li></ul>Ces fonctionnalités semblent disponibles dans la version enterprise à 100$/machine/an.<br /><br /><h2>Premiers pas</h2>Assez parlé il est temps de jouer un peu avec Ansible !<br /><br /><h3>Installation d'Ansible</h3>L'installation est facile et prévue pour à peu près toutes les distributions Linux et même pour Mac sur la page <a class="http" href="http://www.ansibleworks.com/docs/gettingstarted.html" title="getting started">getting started</a>.<br /><br />Pour ma part j'ai installé ça via <a class="https" href="https://launchpad.net/~rquillo/+archive/ansible" title="un PPA">un PPA</a>:<br /><br />On ajoute ça à nos sources:<br /><pre class="prettyprint">deb <a class="http" href="http://ppa.launchpad.net/rquillo/ansible/ubuntu" title="http://ppa.launchpad.net/rquillo/ansible/ubuntu">http://ppa.launchpad.net/rquillo/ansible/ubuntu</a> precise main <br /><br />deb-src <a class="http" href="http://ppa.launchpad.net/rquillo/ansible/ubuntu" title="http://ppa.launchpad.net/rquillo/ansible/ubuntu">http://ppa.launchpad.net/rquillo/ansible/ubuntu</a> precise main<br /></pre><br />Et puis:<br /><pre class="prettyprint">sudo apt-get install ansible<br /></pre><br />Et c'est bon ! <br /><br /><h3>Premiers tests</h3>Pour faire nos tests nous allons initier une machine virtuelle via Vagrant:<br /><pre class="prettyprint">vagrant init precise64<br /></pre><br />Et on lance notre vm:<br /><pre class="prettyprint">vagrant up<br /></pre><br />Une fois la machine up nous allons faire un simple test de connexion à notre VM. Tout d'abord créons un dossier ansible à côté de notre Vagrantfile afin de travailler:<br /><pre class="prettyprint">mkdir ansible &amp;&amp; cd ansible<br /></pre><br />On créé ensuite le fichier <b>hosts</b> qui va contenir la liste des machines de notre plateforme qui ne contient qu'une machine:<br /><pre class="prettyprint">127.0.0.1 ansible_ssh_port=2222 ansible_connection=paramiko<br /></pre><br />Le paramètre "ansible_ssh_port" permet de spécifier un port différent du port 22 par défaut pour se connecter via SSH. Le port 2222 est une redirection du port 22 de notre VM qui est ouvert automatiquement par Vagrant.<br /><br />Le paramètre "ansible_connection" a été nécessaire pour moi afin de contourner <a class="https" href="https://github.com/ansible/ansible/issues/3882#issuecomment-23840576" title="un bug">un bug</a> qui avait pour conséquence que Ansible restait bloqué après la connexion.<br /><br />Pour info ce type de connexion est le type par défaut à partir d'Ansible 1.3.1 (j'ai fait mes tests avec la v1.2.2).<br /><br /><br />Et ensuite on lance le module "ping" (inclus dans Ansible) sur l'ensemble des machines de notre plateforme (donc juste en local):<br /><pre class="prettyprint">ansible all -i hosts -m ping -u vagrant -k<br /></pre><br />Les options utilisées:<br /><ul><li>all: permet de préciser à quel groupe/machine appliquer la commande ou le module</li><li>-i : pour préciser le fichiers hosts à utiliser (par défaut /etc/ansible/hosts)</li><li>-m: le nom du module à exécuter</li><li>-u: l'utilisateur utilisé pour la connexion</li><li>-k: demander le mot de passe sur l'entrée standard</li></ul>Et le résultat:<br /><pre class="prettyprint">localhost | success &gt;&gt; {<br /><br />    "changed": false, <br /><br />    "ping": "pong"<br /><br />}<br /></pre><br />Ça marche ! On va maintenant exécuter une commande Unix quelconque, par exemple "uptime". Cela se fait via la commande suivante:<br /><pre class="prettyprint">ansible all -i hosts -m shell -a "uptime" -u vagrant -k<br /></pre><br />Et le résultat:<br /><pre class="prettyprint">localhost | success | rc=0 &gt;&gt;<br /><br /> 19:26:06 up 17 min,  2 users,  load average: 0.28, 0.33, 0.32<br /></pre><br /><br />Tout fonctionne on va maintenant créer un module afin d'organiser un peu notre travail.<br /><br /><h3>Structure d'un rôle</h3>Les modules se nomment dans Ansible des playbook et représente en gros une liste de tâches au format YAML.<br /><br />D'après la page <a class="http" href="http://www.ansibleworks.com/docs/bestpractices.html" title="Best practices">Best practices</a> nous allons créer quelques fichiers à la racine de notre dossier ansible:<br /><ul><li>Un fichier nommé "production" qui va contenir la liste de nos serveurs de production en l'occurrence uniquement les lignes suivantes:</li></ul><pre class="prettyprint">[application-server]<br /><br />127.0.0.1 ansible_ssh_port=2222 ansible_connection=paramiko<br /></pre><br />Nous allons également déclarer un playbook maître qui aura pour seule fonction d'inclure les autres playbooks afin de mieux séparer les choses:<br /><ul><li>site.yml:</li></ul><pre class="prettyprint">- include: appservers.yml<br /></pre><br />Et notre fichier appservers.yml contenant les différents rôles de nos serveurs d'application:<br /><br /><pre class="prettyprint">- hosts: application-server<br />&nbsp;<br />  roles:<br />&nbsp;&nbsp;<br />    - tomcat8<br /></pre><br /><br />Et maintenant la structure standard d'un rôle:<br /><br />├── appservers.yml<br />├── production<br />├── roles<br />│&nbsp;&nbsp; └── tomcat8<br />│&nbsp;&nbsp;     ├── files<br />│&nbsp;&nbsp;     ├── handlers<br />│&nbsp;&nbsp;     ├── tasks<br />│&nbsp;&nbsp;     └── templates<br />└── site.yml<br /><br /><br />Quelques explications:<br /><br /><ul><li>Sous le dossier roles, un dossier pour chaque rôle (tomcat8 par exemple)</li><li>Ce dossier contient des sous-dossiers:</li><ul><li>tasks: le fichier principal contenant la liste des tâches associées au rôle tomcat8</li><li>files: des fichiers destinés à être copié en tant que tels sur les serveurs cibles</li><li>handlers: les handlers utilisés par nos tâches (on verra un handler en détail un peu plus tard)</li><li>templates: les templates permettant de générer des fichiers instanciés en fonction des variables du serveur</li></ul></ul>C'est tout pour cette fois-ci dans le prochain article on réalisera un playbook permettant d'installer Tomcat 8 sur Ubuntu 12.04 !<br /><br />Edit: <a href="http://blog.nantern.com/fr/2013/09/07/ansible-l-orchestration-facile-2-2.html" target="_blank">l'article 2</a> vient d'être publié ! <br /><br /><br />Post 13/52</div>
