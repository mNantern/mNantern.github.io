---
layout: post
title: Memcached - Gestion de la mémoire
date: 2013-03-08
comments: false
categories: fr
excerpt: Deuxième partie d'une série sur Memcached, un cache distribué haute performance. Aujourd'hui le détail du fonctionnement de la gestion de la mémoire dans Memcached.
---

<div class='post'>
<div class="separator" style="clear: both; text-align: center;"><a href="{{site.url}}/assets/memcached.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="{{site.url}}/assets/memcached.png" height="118" width="640" /></a></div><br />Cet article fait partie d'une série de trois posts sur Memcached. Il fait suite au premier article: <a href="http://blog.nantern.com/fr/2013/03/06/memcached-principe-de-fonctionnement.html" target="_blank">"Memcached: principe de fonctionnement"</a><br /><br />Deuxième article sur Memcached et on passe aux choses sérieuses, la gestion de la mémoire par Memcached !<br /><br /><br /><h2>Gestion de la mémoire par Memcached</h2><h3>Expiration</h3>En fonctionnement nominal la mémoire utilisée par les éléments expirés dans Memcached n'est pas réclamée activement. Ainsi même si l'élément est expiré alors sa mémoire ne sera pas libérée immédiatement.<br />Un cas particulier arrive quand on essaye de récupérer un élément expiré. Dans ce cas Memcached va se rendre compte que l'élément est expiré et libérer immédiatement la mémoire utilisée.<br /><br /><h3>Insertion d'un élément dans le cache</h3>Lorsque l'on ajoute un nouvel élément dans Memcached celui-ci vérifie un certain nombre de choses:<br /><br /><ul><li>Étape 1: Reste-t-il de la place dans la page courante ?</li><li>Étape 2: Reste-t-il des pages mémoires non allouée à un slab ?</li><li>Étape 3: Déclenchement de l'algorithme LRU</li></ul><br /><h4>Étape 1 : affectation simple</h4><h4>&nbsp;</h4>Cette étape est la plus simple et la plus classique: s'il reste de l'espace dans la page courante alors on utilise un chunk de cette page pour stocker notre élément.<br />Rien de bien compliqué ici !<br /><br /><br /><h4>Étape 2 : assignation d'une page</h4><h4>&nbsp;</h4>Nous arrivons dans cette étape s'il n'y a plus de chunk libre dans la page courante. A ce moment Memcached vérifie s'il lui reste des pages mémoire de 1 Mio non affectée au slab courant et si c'est le cas alors il assigne une plage libre au slab courant.<br />En faisant cela il découpe également cette page en chunk de même taille et utilise un de ces chunk pour stocker l'élément à insérer.<br /><br /><br /><b>Attention</b> : une fois qu'une page est assignée à un slab cette page ne peut plus être affectée à un autre slab.<br /><br /><br /><h4>Étape 3 : LRU et éviction</h4><h4>&nbsp;</h4>S'il n'y a plus de chunk ni de page disponibles alors Memcached va commencer à libérer de l'espace en utilisant un algorithme de type <a class="https" href="https://en.wikipedia.org/wiki/Cache_algorithms#Least_Recently_Used" title="LRU">LRU</a> (Least Recently Used). Le principe de cet algorithme est de maintenir une liste d'éléments par date d'utilisation. Ainsi un élément peu utilisé apparaîtra dès le début de cette liste. Memcached va alors parcourir les premiers éléments de la liste et libérer l'espace utilisé par un élément expiré.<br /><br /><br />La particularité de Memcached est qu'il ne maintient pas une liste globale listant l'ensemble des éléments mais une liste par slab. Ainsi l'algorithme LRU n'est pas global mais local par slab. Memcached conserve une liste d'éléments par slab:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="{{site.url}}/assets/memcache3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="{{site.url}}/assets/memcache3.png" height="640" width="500" /></a></div><br /><br /><br />Ainsi dans le scénario 1 l'algorithme LRU va parcourir le début de liste et supprimer l'élément 2 car il est expiré. Dans le scénario 2 au contraire il n'y a pas d'élément expiré dans les premiers éléments de la liste, Memcached va alors "évincer" le premier élément même si celui-ci n'est pas encore expiré. Cette action se nomme une <b>eviction</b>.<br /><br /><br />Habituellement on n'aime pas trop les évictions car elles correspondent à la suppression d'un élément encore valide dans Memcached. Néanmoins sur certains environnements où la mémoire est limitée ou la quantité d'éléments à stocker est très important il est intéressant de s'appuyer sur ce mécanisme pour conserver dans le Memcached les éléments les plus couramment utilisés et supprimer les autres.<br /><br /><br />Ce mécanisme fonctionne bien en général mais il peut arriver que malgré tout Memcached manque de mémoire et soit incapable d'en retrouver:<br />Supposons que l'on dispose de 3 slabs : slab1, slab2 et slab3.<br />Au démarrage du processus memcached tous les éléments sont insérés dans le slab1 et le slab3 et toute la mémoire allouée à Memcached est utilisée. A ce moment si l'on insère un nouvel élément dans le slab1 ou le slab3 le mécanisme de LRU va se déclencher pour libérer de la mémoire et donc stocker notre élément.<br /><br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="{{site.url}}/assets/memcache4.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="{{site.url}}/assets/memcache4.png" height="628" width="640" /></a></div><br /><br /><br />Mais imaginons que l'on souhaite insérer un élément dont la taille le destine à être stocké dans le slab2. Comme il n'est pas possible de réaffecter une page à un autre slab, nous ne pourrons jamais insérer notre nouvel élément dans Memcached et une erreur est renvoyée:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="{{site.url}}/assets/memcache5.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="{{site.url}}/assets/memcache5.png" height="628" width="640" /></a></div><br /><br /><br />Cette exemple montre bien qu'il est primordial de bien configurer son serveur Memcached afin d'en tirer le maximum. C'est ce que nous allons voir dans la troisième et dernière partie: <a href="http://blog.nantern.com/fr/2013/03/09/memcached-optimisation.html" target="_blank">"Memcached: optimisation"</a>.<br /><br />Posts&nbsp; 5/52&nbsp; </div>
