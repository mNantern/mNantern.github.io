<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Memcached - optimisation</title>
        <meta name="viewport" content="width=device-width">
	    <link rel="alternate" type="application/atom+xml" href="http://blog.nantern.com/en/atom.xml" title="English Atom feed">
	    <link rel="alternate" type="application/atom+xml" href="http://blog.nantern.com/fr/atom.xml" title="French Atom feed">
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

	<link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon" />
    </head>
    <body>

	<div class="left-pannel">
	  <ul class="icon-list">
            <li class="icon">
                <a href="http://blog.nantern.com/en" title="Matthieu Nantern - English Blog">
                    <svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMin meet" viewBox="0 0 512 512">
                        <path d="M 192.00,96.00 C 315.712,96.00 416.00,196.289 416.00,320.00 L 368.00,320.00 C 368.00,272.988 349.693,228.791 316.451,195.549 C 283.209,162.307 239.011,144.00 192.00,144.00 L 192.00,96.00 ZM 192.00,0.00 C 368.73,0.00 512.00,143.27 512.00,320.00 L 464.00,320.00 C 464.00,283.26 456.815,247.643 442.645,214.141 C 428.947,181.757 409.328,152.663 384.333,127.667 C 359.337,102.671 330.243,83.052 297.859,69.355 C 264.357,55.185 228.741,48.00 192.00,48.00 L 192.00,0.00 ZM 287.195,224.804 C 309.074,246.682 319.993,275.357 319.98,304.029 C 288.00,352.027 288.00,416.00 288.00,416.00 C 160.00,416.00 64.00,512.00 64.00,512.00 L 57.00,505.00 L 45.435,493.435 L 187.226,351.644 C 188.784,351.877 190.377,352.00 192.00,352.00 C 209.673,352.00 224.00,337.673 224.00,320.00 C 224.00,302.327 209.673,288.00 192.00,288.00 C 174.327,288.00 160.00,302.327 160.00,320.00 C 160.00,321.623 160.123,323.217 160.356,324.774 L 18.565,466.565 L 0.00,448.00 C 0.00,448.00 96.00,352.00 96.00,224.00 C 96.00,224.00 159.999,224.00 207.999,192.00 C 236.663,192.00 265.326,202.935 287.195,224.804 Z" id="path3123" /><text xml:space="preserve" style="font-size:72.1296463px;font-style:normal;font-weight:normal;line-height:125%;letter-spacing:0px;word-spacing:0px;fill-opacity:1;stroke:none;font-family:Sans" x="424.68048" y="419.45462" id="text3139" transform="scale(0.90622656,1.1034768)"><tspan x="424.68048" y="419.45462" id="tspan3141"><tspan x="424.68048" y="419.45462" id="tspan3143">EN</tspan></tspan></text>
                    </svg>
                </a>
            </li>
            <li class="icon">
                <a href="http://blog.nantern.com/fr" title="Matthieu Nantern - French Blog">
                    <svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMin meet" viewBox="0 0 512 512">
                        <path d="M 192.00,96.00 C 315.712,96.00 416.00,196.289 416.00,320.00 L 368.00,320.00 C 368.00,272.988 349.693,228.791 316.451,195.549 C 283.209,162.307 239.011,144.00 192.00,144.00 L 192.00,96.00 ZM 192.00,0.00 C 368.73,0.00 512.00,143.27 512.00,320.00 L 464.00,320.00 C 464.00,283.26 456.815,247.643 442.645,214.141 C 428.947,181.757 409.328,152.663 384.333,127.667 C 359.337,102.671 330.243,83.052 297.859,69.355 C 264.357,55.185 228.741,48.00 192.00,48.00 L 192.00,0.00 ZM 287.195,224.804 C 309.074,246.682 319.993,275.357 319.98,304.029 C 288.00,352.027 288.00,416.00 288.00,416.00 C 160.00,416.00 64.00,512.00 64.00,512.00 L 57.00,505.00 L 45.435,493.435 L 187.226,351.644 C 188.784,351.877 190.377,352.00 192.00,352.00 C 209.673,352.00 224.00,337.673 224.00,320.00 C 224.00,302.327 209.673,288.00 192.00,288.00 C 174.327,288.00 160.00,302.327 160.00,320.00 C 160.00,321.623 160.123,323.217 160.356,324.774 L 18.565,466.565 L 0.00,448.00 C 0.00,448.00 96.00,352.00 96.00,224.00 C 96.00,224.00 159.999,224.00 207.999,192.00 C 236.663,192.00 265.326,202.935 287.195,224.804 Z" id="path3124" /><text xml:space="preserve" style="font-size:72.1296463px;font-style:normal;font-weight:normal;line-height:125%;letter-spacing:0px;word-spacing:0px;fill-opacity:1;stroke:none;font-family:Sans" x="424.68048" y="419.45462" id="text3140" transform="scale(0.90622656,1.1034768)"><tspan x="424.68048" y="419.45462" id="tspan3142"><tspan x="424.68048" y="419.45462" id="tspan3144">FR</tspan></tspan></text>
                    </svg>
                </a>
            </li>
            <li class="icon">
                <a href="http://shaarli.nantern.com" title="Matthieu Nantern - My Links">
                    <svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMin meet" viewBox="0 0 512 512">
                        <g id="g3083" transform="matrix(4.3715413,0,0,4.463624,-16.575132,-35.495361)"><path d="m 89.675848,114.54845 c -5.552753,-1.98021 -13.47546,-7.5052 -19.317617,-13.47136 l -5.095743,-5.203906 -3.095826,5.485506 c -1.702704,3.01702 -4.666474,6.68349 -6.586156,8.1477 -7.05655,5.3823 -18.671526,7.02628 -25.370344,3.59093 -9.2295,-4.73317 -11.243098,-11.66563 -6.788069,-23.370149 C 24.839942,86.002115 26,82.559499 26,82.076912 26,81.594325 23.75831,80.661708 21.018466,80.00443 14.548469,78.452301 8.2428743,73.825528 6.3175215,69.21751 4.2369392,64.237976 4.9792426,56.242263 7.9033546,52.135726 11.766444,46.710517 21.953112,43 32.984121,43 c 8.735067,0 9.489072,-0.691946 10.693315,-9.813197 1.933963,-14.648348 7.747709,-21.944715 18.292919,-22.957976 6.288495,-0.6042451 9.121558,0.136188 12.996423,3.396672 4.338406,3.650528 6.995175,9.347462 9.016605,19.334386 L 85.711967,41.5 l 4.882126,0.701162 c 16.006047,2.298759 26.596447,9.111789 27.912357,17.956606 0.38114,2.561773 0.39149,6.030412 0.023,7.708088 -0.93278,4.246953 -6.42278,8.7746 -11.69858,9.647935 -6.11997,1.013072 -6.25035,1.244432 -2.87058,5.093772 10.38187,11.824298 9.891,27.433927 -0.99974,31.791537 -4.816145,1.92704 -8.193387,1.96501 -13.284712,0.14935 z M 48.05659,91.809193 c 2.256703,-2.854944 5.243467,-7.467444 6.637253,-10.25 5.819648,-11.61835 7.029505,-11.469022 20.457677,2.525012 10.775128,11.229191 12.868206,12.426024 15.214702,8.699847 C 91.275073,91.34082 89.809581,89.404341 81.145264,80.599613 73.137129,72.461701 70.916769,69.615613 71.171858,67.815561 71.491417,65.560566 71.840027,65.486922 84.5,65 91.65,64.725 98.0625,64.135942 98.75,63.690983 103.18376,60.82139 95.72784,58.072843 81.431438,57.306679 75.074812,56.966019 69.605134,56.206148 69.123257,55.596773 68.646242,54.993548 68.031192,49.515963 67.756479,43.424363 67.228799,31.723388 66.101666,28 63.087261,28 59.642286,28 58.681268,30.772816 58.036594,42.572644 57.194617,57.983813 57.4614,57.739874 40.5,58.607619 27.152179,59.290492 24,60.029544 24,62.476167 c 0,2.306708 1.787465,2.779574 11.370136,3.007919 10.19538,0.242945 13.178727,0.897887 14.014821,3.076711 0.595683,1.552325 -2.220937,8.185808 -7.357403,17.327578 C 40.362399,88.851981 39,92.564481 39,94.138375 39,96.516944 39.418087,97 41.476746,97 c 1.790599,0 3.613453,-1.438041 6.579844,-5.190807 z" id="path3099" /></g>
                    </svg>
                </a>
            </li>
<li class="icon">
                <a href="http://github.com/mNantern" title="Matthieu Nantern - mNantern on GitHub">
                    <svg preserveAspectRatio="xMinYMin meet" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <path d="M 256.00,0.00C 114.615,0.00,0.00,114.615,0.00,256.00s 114.615,256.00, 256.00,256.00s 256.00-114.615, 256.00-256.00S 397.385,0.00, 256.00,0.00z M 408.028,408.028 c-19.759,19.758-42.756,35.266-68.354,46.093c-6.503,2.75-13.107,5.164-19.80,7.246L 319.874,423.00 c0.00-20.167-6.917-35.00-20.75-44.50 c 8.667-0.833, 16.625-2.00, 23.875-3.50s 14.917-3.667, 23.00-6.50s 15.333-6.208, 21.75-10.125s 12.583-9.00, 18.50-15.25s 10.875-13.333, 14.875-21.25 s 7.167-17.417, 9.50-28.50s 3.50-23.292, 3.50-36.625c0.00-25.833-8.417-47.833-25.25-66.00c 7.667-20.00, 6.833-41.75-2.50-65.25l-6.25-0.75 c-4.333-0.50-12.125,1.333-23.375,5.50s-23.875,11.00-37.875,20.50c-19.833-5.50-40.417-8.25-61.75-8.25c-21.50,0.00-42.00,2.75-61.50,8.25 c-8.833-6.00-17.208-10.958-25.125-14.875c-7.917-3.917-14.25-6.583-19.00-8.00s-9.167-2.292-13.25-2.625s-6.708-0.417-7.875-0.25 s-2.00,0.333-2.50,0.50c-9.333,23.667-10.167,45.417-2.50,65.25c-16.833,18.167-25.25,40.167-25.25,66.00c0.00,13.333, 1.167,25.542, 3.50,36.625 s 5.50,20.583, 9.50,28.50s 8.958,15.00, 14.875,21.25s 12.083,11.333, 18.50,15.25s 13.667,7.292, 21.75,10.125s 15.75,5.00, 23.00,6.50 s 15.208,2.667, 23.875,3.50c-13.667,9.333-20.50,24.167-20.50,44.50l0.00,39.115 c-7.549-2.247-14.99-4.902-22.30-7.994 c-25.597-10.827-48.594-26.335-68.353-46.093c-19.758-19.759-35.267-42.756-46.093-68.354C 46.679,313.195, 41.00,285.043, 41.00,256.00 s 5.679-57.195, 16.879-83.675c 10.827-25.597, 26.335-48.594, 46.093-68.353s 42.756-35.267, 68.353-46.093 C 198.805,46.679, 226.957,41.00, 256.00,41.00s 57.195,5.679, 83.675,16.879c 25.598,10.827, 48.595,26.335, 68.354,46.093 c 19.758,19.758, 35.266,42.756, 46.093,68.353C 465.321,198.805, 471.00,226.957, 471.00,256.00s-5.679,57.195-16.879,83.675 C 443.294,365.272, 427.786,388.27, 408.028,408.028z" ></path>
                    </svg>
                </a>
            </li>
            <li class="icon">
                <a href="http://fr.linkedin.com/pub/matthieu-nantern/62/836/589/" title="Matthieu Nantern on LinkedIn">
                    <svg preserveAspectRatio="xMinYMin meet" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <path d="M 426.00,0.00L 86.00,0.00 C 38.70,0.00,0.00,38.70,0.00,86.00l0.00,340.00 c0.00,47.30, 38.70,86.00, 86.00,86.00l 340.00,0.00 c 47.30,0.00, 86.00-38.70, 86.00-86.00L 512.00,86.00 C 512.00,38.70, 473.30,0.00, 426.00,0.00z M 192.00,416.00l-64.00,0.00 L 128.00,192.00 l 64.00,0.00 L 192.00,416.00 z M 160.00,160.00c-17.673,0.00-32.00-14.327-32.00-32.00s 14.327-32.00, 32.00-32.00s 32.00,14.327, 32.00,32.00S 177.673,160.00, 160.00,160.00z M 416.00,416.00l-64.00,0.00 L 352.00,288.00 c0.00-17.673-14.327-32.00-32.00-32.00s-32.00,14.327-32.00,32.00l0.00,128.00 l-64.00,0.00 L 224.00,192.00 l 64.00,0.00 l0.00,39.736 C 301.199,213.604, 321.376,192.00, 344.00,192.00c 39.765,0.00, 72.00,35.817, 72.00,80.00 L 416.00,416.00 z" ></path>
                    </svg>
                </a>
            </li>
            <li class="icon"><a href="https://twitter.com/mNantern" title="Matthieu Nantern on Twitter"><svg preserveAspectRatio="xMinYMin meet" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M 256.00,0.00C 114.615,0.00,0.00,114.615,0.00,256.00s 114.615,256.00, 256.00,256.00s 256.00-114.615, 256.00-256.00S 397.385,0.00, 256.00,0.00z M 403.121,180.544 c 0.146,3.254, 0.221,6.528, 0.221,9.819c0.00,100.311-76.354,215.982-215.979,215.982c-42.868,0.00-82.768-12.568-116.363-34.107 c 5.938,0.704, 11.981,1.063, 18.108,1.063c 35.565,0.00, 68.295-12.138, 94.275-32.497c-33.217-0.61-61.25-22.561-70.912-52.716 c 4.637,0.884, 9.392,1.361, 14.283,1.361c 6.923,0.00, 13.629-0.928, 19.999-2.662c-34.726-6.976-60.893-37.656-60.893-74.434 c0.00-0.32,0.00-0.639, 0.008-0.955c 10.235,5.685, 21.939,9.10, 34.382,9.494c-20.37-13.611-33.77-36.846-33.77-63.184 c0.00-13.911, 3.744-26.952, 10.278-38.162c 37.439,45.927, 93.374,76.146, 156.462,79.314c-1.294-5.559-1.965-11.351-1.965-17.302 c0.00-41.92, 33.99-75.906, 75.909-75.906c 21.833,0.00, 41.562,9.218, 55.409,23.97c 17.29-3.404, 33.537-9.721, 48.206-18.42 c-5.668,17.727-17.705,32.603-33.376,41.997c 15.355-1.834, 29.984-5.916, 43.597-11.952 C 430.825,156.471, 417.955,169.84, 403.121,180.544z" ></path></svg></a></li>
	</ul>		
</div>


<div class="site">
        <h1 class="post-title">Memcached - optimisation</h1>
<p class="meta">09 Mar 2013</p>

<div class="post">
<div class='post'>
<div class="separator" style="clear: both; text-align: center;"><a href="http://blog.nantern.com/assets/memcached.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://blog.nantern.com/assets/memcached.png" height="118" width="640" /></a></div><br />Cet article fait partie d'une série de trois posts sur Memcached. Il fait suite au premier article: <a href="http://blog.nantern.com/fr/2013/03/06/memcached-principe-de-fonctionnement.html" target="_blank">"Memcached: principe de fonctionnement"</a> et au deuxième article: <a href="http://blog.nantern.com/fr/2013/03/08/memcached-gestion-de-la-memoire.html" target="_blank">"Memcached: Gestion de la mémoire"</a>.<br />Troisième et dernier article sur Memcached et on finit en beauté: comment optimiser son Memcached afin de faire toujours plus avec la même quantité de mémoire !<br /><br /><h2>Optimiser l'utilisation de son Memcached</h2><h3>Superviser son Memcached</h3>Avant de modifier les paramètres de son Memcached il faut d'abord pouvoir les observer afin de vérifier que ce que l'on fait améliore effectivement les choses.<br /><br />   Pour cela deux options faciles:<br /><br /><ul><li>utiliser l'<a href="http://lzone.de/articles/memcached.htm" title="interface telnet">interface telnet</a> fournie afin d'obtenir des informations sur le serveur. Les informations intéressantes sont fournies par la commande "stats" et "stats slabs"</li><li>utiliser un script PHP affichant de manière un peu plus sympathique l'état du Memcached. Ce script est disponible sur <a href="http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/" title="le blog de l'auteur">le blog de l'auteur</a>.</li></ul><div class="separator" style="clear: both; text-align: center;"><a href="http://blog.nantern.com/assets/apc_memcache.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><br /></a></div><div class="separator" style="clear: both; text-align: center;"><a href="http://blog.nantern.com/assets/apc_memcache.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://blog.nantern.com/assets/apc_memcache.png" height="334" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><br /><br /> <br /><br />   Les informations qui nous intéressent sont le compteur d'éviction (accessible uniquement via l'interface telnet) et le nombre d'éléments par slabs (via la commande "stats slabs" ou le bouton "variables" de memcached.php):<br /><br />  <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://blog.nantern.com/assets/apc_memcache2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://blog.nantern.com/assets/apc_memcache2.png" height="408" width="640" /></a></div><br /><br />  <h3>Quelques conseils</h3>Afin de tirer le meilleur partie de Memcached il faut vérifier que:<br /><br /><ol start="1" type="1"><li>Les dates d'expiration ont été correctement paramétrées ; rien ne sert de remplir la mémoire avec des éléments inutiles. Vérifier pour cela le pourcentage de hit sur vos get memcached si celui-ci est trop bas soit vous n'avez pas assez de mémoire pour stocker tous vos éléments soit vos durées d'expiration sont trop courtes.<br /></li><li>Les données sont réparties harmonieusement au sein des slabs: si vous avez un slab qui contient 90% des éléments il peut être intéressant de partitionner plus finement ce slab en jouant sur les paramètres -n (plage de début) et -f (facteur d'augmentation). Voir à ce sujet l'exemple ci-dessous<br /></li><li>Vérifier régulièrement la taille des objets que vous stockez dans Memcached car au fur et à mesure que votre application s'étoffe il se peut que la taille des données stockées dans Memcached augmente et que les paramètres initiaux ne soient plus adaptés.</li></ol>J'ai mis en pratique récemment le conseil numéro 2: il faut savoir que sur mon projet actuel nous utilisons énormément Memcached mais que les paramètres mis en place datent de plus de 4 ans et que le projet n'a plus grand chose à voir avec ce qu'il était à l'époque.<br />En étudiant l'un des Memcached voici ce que j'ai pu constater:<br /><br /><ul><li>De nombreuses évictions (1 par seconde en moyenne)</li><li>65 000 objets max stockés dans le Memcached</li><li>Une distribution sur les différents slabs complètement disproportionnée:</li></ul><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://blog.nantern.com/assets/memcache1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://blog.nantern.com/assets/memcache1.png" height="372" width="640" /></a></div><br />Avec -n = 8000 et -f = 2<br /><br /><br />   On voit clairement sur le graphique que le premier slab contient l'immense majorité des données. Le paramètre de taille initiale du slab a été visiblement mal choisi et il faut l'affiner.<br />La principale conséquence de ce choix est que l'on utilise 8 kio de mémoire pour tous les objets stockés dans Memcached alors que ceux-ci font en moyenne entre 3 et 4 kio (soit 50% de mémoire perdue à chaque fois!!) ce qui implique que l'on ne peut stocker que peu d'informations.<br />On voit bien ici l'importance de connaître ses données afin d'optimiser au mieux les paramètres.<br /><br />  <br />Nous avons donc modifié les paramètres comme suit:<br /><br /><ul><li>Diminution de la taille du premier slab de 8000 octets à 1000 octets afin de mieux découper l'espace où se trouve nos données</li><li>Même facteur d'accroissement</li><li>Même mémoire allouée</li></ul><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://blog.nantern.com/assets/memcache2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://blog.nantern.com/assets/memcache2.png" height="376" width="640" /></a></div><br /><br /><br /><br />   Les conséquences de cette modification:<br /><br /><ul><li>Peu d'évictions (Quelques centaines par jour)</li><li><b>125 000 éléments stockés dans Memcached</b> (pour la même quantité de mémoire allouée !!)</li><li>Une distribution mieux répartie</li></ul>On peut se dire au vu du graphique qu'il est encore possible de faire mieux en diminuant le facteur multiplicatif afin de décomposer encore plus le slab3 en de multiples slabs. Cette solution n'a pas été retenue car nous souhaitions garder une relative flexibilité dans la taille de nos données qui sont amenées à bouger régulièrement et donc nous focaliser sur la tranche 3 à 4 kio nous semblait trop réducteur pour les développements futurs de l'application.<br /><br /><br />   C'est ainsi que se termine cette série de trois articles sur Memcached un outil fantastique pour améliorer les performances et la scalabilité de votre application.<br /><br /><br /><br /><br />   Quelques liens intéressants:<br /><br /><ul><li>La page du <a href="http://memcached.org/" title="projet Memcached">projet Memcached</a></li><li>L'algorithme <a href="http://work.tinou.com/2011/04/memcached-for-dummies.html" title="LRU de Memcached en détail">LRU de Memcached en détail</a></li><li>Le <a href="http://code.google.com/p/memcached/wiki/NewStart?tm=6" title="wiki officiel">wiki officiel</a> de Memcached</li><li>L'<a href="http://lzone.de/articles/memcached.htm" title="interface telnet">interface telnet</a></li></ul>Post 6/52 <br />  </div>

</div>

          <div class="footer">
            <div class="contact">
              <p>
                Matthieu Nantern<br />
                <a href="mailto:matthieu.nantern@gmail.com">matthieu.nantern@gmail.com</a><br />
		<a href="https://twitter.com/mNantern">@mNantern</a>
              </p>
            </div>
          </div>
        </div>

    </body>
</html>
